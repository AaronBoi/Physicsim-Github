<!DOCTYPE html>

<html>

    <head>
        <title>Feder</title>

        <style>
            .table{
                display: flex;
                flex-direction: row;
                margin: 5px;
            }
            .section{
                display: flex;
                flex-direction: column;
                flex-wrap: wrap;
                margin: 10px;
            }
        </style>
    </head>   



    <body>
        <!--
        <div class = "table">
            <div class ="section">
                <div>
                    test1 : <t id ="test1"></t>
                </div>
                <div>
                    test2 : <t id ="test2"></t>
                </div>
            </div>
        </div>
        -->

        <canvas id="myCanvas" style="border:2px solid"></canvas>
        

        <script>
        

        //canvas setup-----------------------------

        var canvas = document.getElementById("myCanvas");
        var c = canvas.getContext("2d");

        canvas.width = window.innerWidth - 20;
        canvas.height = window.innerHeight - 100;

        var simMinWidth = 20.0;
        var cScale = Math.min(canvas.width, canvas.height) / simMinWidth;
        var simWidth = canvas.width / cScale;
        var simHeight = canvas.height / cScale;

        function cX(pos) {
            return pos.x * cScale;
        }

        function cY(pos){
            return canvas.height - pos.y * cScale;
        }
        
        //scene

        //vector math------------------------------

        class Vector2 {
            constructor(x = 0.0, y = 0.0) {
                this.x = x; 
                this.y = y;
            }

            set(v) {
                this.x = v.x; this.y = v.y;
            }

            clone() {
                return new Vector2(this.x, this.y);
            }

            add(v, s = 1.0) {
                this.x += v.x * s;
                this.y += v.y * s;
                return this;
            }

            addVectors(a, b) {
                this.x = a.x + b.x;
                this.y = a.y + b.y;
                return this;
            }

            subtract(v, s = 1.0) {
                this.x -= v.x * s;
                this.y -= v.y * s;
                return this;
            }

            subtractVectors(a, b) {
                this.x = a.x - b.x;
                this.y = a.y - b.y;
                return this;			
            }

            length() {
                return Math.sqrt(this.x * this.x + this.y * this.y);
            }

            scale(s) {
                this.x *= s;
                this.y *= s;
                return this;
            }

            dot(v) {
                return this.x * v.x + this.y * v.y;
            }
            norm() {
                var l = this.length();
                if(l > 0) {
                    this.x = this.x / l;
                    this.y = this.y / l;
                }
            }
        }

        class Ball {
            constructor(radius, pos, vel, mass){
                this.radius = radius;
                this.mass = mass;
                this.pos = pos.clone();
                this.vel = vel.clone();
            }
            springAcc(spring) {
                var d = new Vector2().subtractVectors(this.pos, spring);
                var x = d.length() - physicsScene.restLength;
                d.norm();
                d.scale(-1 * physicsScene.cSpring * x / this.mass);
                return d;
                //document.getElementById("test1").innerHTML = d.y;

            }
            simulate(dt, gravity) {
                this.vel.add(gravity, dt);
                this.vel.add(this.springAcc(physicsScene.Anchor), dt);
                this.pos.add(this.vel, dt);
                this.vel.scale(1);
                //document.getElementById("test1").innerHTML = this.vel.x;
            }

        }

        var physicsScene = 
        {
            cSpring : 10,
            restLength : 12,
            Anchor : new Vector2(simWidth / 2, 0.99 * simHeight),
            gravity : new Vector2(0.0, -9.81),
            dt : 1.0 / 75,
            worldSize : new Vector2(simWidth, simHeight),
            //paused: false,
            balls: [],
        };

        function setupScene() 
        {
            var numBalls = 1;
            var radius = 1.0;
            var mass = 2;
            var pos = new Vector2(simWidth / 2.0, 0.6 * simHeight - radius);
            var vel = new Vector2(0.0, 0.0);

            physicsScene.balls[0] = new Ball(radius, pos, vel, mass);

        }

        //drawing----------------------------------

        function draw() 
        {
            c.clearRect(0, 0, canvas.width, canvas.height);
            c.fillStyle = "#FF0000";
            var ball = physicsScene.balls[0];

            
            //c.stroke();

            /*c.strokeStyle = 'black';
            c.lineWidth = 2;
            c.beginPath();
            c.moveTo(0, 0);
            c.lineTo(50, 100);
            
            c.stroke();*/


            var Anchor = physicsScene.Anchor;
            c.strokeStyle = 'black';
            c.lineWidth = 2;
            c.beginPath();
            c.moveTo(cX(Anchor) - 50, cY(Anchor));
            c.lineTo(cX(Anchor) + 50, cY(Anchor));
            c.stroke();

            c.strokeStyle = 'black';
            c.lineWidth = 2;
            c.beginPath();
            c.moveTo(cX(Anchor), cY(Anchor));
            c.lineTo(cX(ball.pos), cY(ball.pos));
            c.stroke();

            c.beginPath();			
            c.arc(
                cX(ball.pos), cY(ball.pos), cScale * ball.radius, 0.0, 2.0 * Math.PI); 
            c.closePath();
            c.fill();

            
        }


        //simulation

        //update------------------------------------
        var mousePos;
        var touch = false;
        var numSteps = 50;
        function update(){
            for (var i = 0; i < numSteps; i++) {
                var ball1 = physicsScene.balls[0];
                ball1.simulate(physicsScene.dt / numSteps, physicsScene.gravity);
            }
            
            draw();


            requestAnimationFrame(update);

            if(touch) {
                physicsScene.balls[0].pos = mousePos;
                physicsScene.balls[0].vel.scale(0);
            }
        }

        setupScene();
        update();

        //canvas.addEventListener("touchstart", onTouchStart, false);
        //canvas.addEventListener("touchend", onTouchEnd, false);

        canvas.addEventListener("mousedown", onMouseDown, false);
        canvas.addEventListener("mouseup", onMouseUp, false);
        canvas.addEventListener("mousemove", onMouseMove, false);

        function onMouseDown(event)
        {
            var rect = canvas.getBoundingClientRect();
            window.mousePos = new Vector2(
                (event.clientX - rect.left) / cScale,
                simHeight - (event.clientY - rect .top) / cScale);
            window.touch = true;
        }

        function onMouseUp(event)
        {
            window.touch = false;
        }

        function onMouseMove(event)
        {
            var rect = canvas.getBoundingClientRect();
            window.mousePos = new Vector2(
                (event.clientX - rect.left) / cScale,
                simHeight - (event.clientY - rect .top) / cScale);
        }

        
        </script>

    </body>

</html>
